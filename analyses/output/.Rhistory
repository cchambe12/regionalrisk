frz<-frz[!(is.na(frz$Tmin) & is.na(frz$PEP_ID)),]
frz<-frz[!(is.na(frz$Tmin),]
#write.csv(d, "~/Documents/git/regionalrisk/analyses/output/acer_combined.csv", row.names=FALSE)
########################## Lame Attempts to keep for now #########################
#tt<-d
#tt$lat<-round(d$lat, digits=2)
#tt$LAT<-round(d$LAT, digits=2)
#tt$long<-round(d$long, digits=2)
#tt$LON<-round(d$LON, digits=2)
how_many<-d[which(is.na(d$Tmin)),]
peps<-as.data.frame(table(unique(how_many$PEP_ID)))
peps<-peps%>%rename("PEP_ID" = Var1)%>% rename("peps"=Freq)
df<-as.data.frame(table(d$PEP_ID))
df<-df%>%rename("PEP_ID" = Var1)%>%rename("df"=Freq)
hmmm<-cbind(peps, df)
d<-d%>%filter(!PEP_ID %in% peps)
unique(d$year)
xx<-d%>%
group_by(year, PEP_ID, DAY)%>%
arrange(PEP_ID) %>%
filter(row_number()==1 | row_number()==n())
#write.csv(d, "~/Desktop/join.csv", row.names=FALSE)
twelve<-d%>%
filter(year==2001)
twelve$BBCH<-ifelse(twelve$BBCH>0, TRUE, FALSE)
xx<-twelve%>%
filter(!is.na(Tmin))
ids<-as.data.frame(table(xx$PEP_ID))
twel<-twelve%>%
group_by(lat, long, PEP_ID)%>%
arrange(BBCH) %>%
filter(row_number()==1 | row_number()==n())
subby<-na.omit(twelve)
substart<-subby%>%
group_by(year, PEP_ID, BBCH)%>%
arrange(PEP_ID)%>%
filter(row_number()==1)
substart$start<-"First"
subend<-subby%>%
group_by(year, PEP_ID, BBCH)%>%
arrange(PEP_ID)%>%
filter(row_number()==n())
subend$end<-"Last"
full_join
try<-d %>%
filter(year>=1950)%>%
group_by(year, lat, long, DAY)%>%
arrange(year) %>%
filter(row_number()==1 | row_number()==n())
frz<-d%>%
group_by(year, lat, long, DAY)%>%
filter(row_number()==1)
ungroup(frz)
check<-frz%>%
group_by(date, lat, long)%>%
arrange(PEP_ID)
frz<-d%>%filter(year%in%years)%>%filter(PEP_ID %in% peps)
many<-frz[which(is.na(frz$Tmin)),]
frz<-frz[!(is.na(frz$Tmin)),]
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(arm)
setwd("~/Documents/git/regionalrisk/analyses/output")
bb<-read.csv("bbch_region_betula.csv", header=TRUE)
clim<-read.csv("climate_betula.csv", header=TRUE)
clim$date<-as.Date(paste(clim$year, clim$month, clim$day, sep="-"))
bb<-bb%>%dplyr::rename("lat" = LAT)%>%dplyr::rename("long"=LON)
x<-paste(bb$YEAR, bb$DAY)
bb$date<-as.Date(strptime(x, format="%Y %j"))
bb$year<-as.numeric(substr(bb$date, 0,4))
bb$month<-as.numeric(substr(bb$date, 6, 7))
bb$day<-as.numeric(substr(bb$date, 9,10))
bb<-bb%>%dplyr::select(-National_ID, -YEAR)
bb$lat<-round(bb$lat, digits=2)
bb$long<-round(bb$long, digits=2)
b.attempt<-bb%>%
group_by(year, PEP_ID, DAY)%>%
arrange(PEP_ID) %>%
filter(row_number()==1 | row_number()==n())
clim$lat<-round(clim$lat, digits=2)
clim$long<-round(clim$long, digits=2)
d<-full_join(clim, bb)
d<-filter(d, year>=1950)
how_many<-d[which(is.na(d$Tmin)),]
d<-d[!(is.na(d$Tmin) & is.na(d$PEP_ID)),]
df<-d%>%dplyr::select(year, PEP_ID, BBCH)
df$BBCH<-ifelse(df$BBCH>=7, df$BBCH, NA)
df<-df%>%group_by(year,PEP_ID)%>%arrange(year)
df<-na.omit(df)
df <- within(df, { count <- ave(BBCH,PEP_ID, year, FUN=function(x) length(unique(x)))})
df$count<-ifelse(df$count>=2,df$count, NA)
xx<-na.omit(df)
unique(xx$year) ## 1997-2015
peps<-unique(xx$PEP_ID)
years<-c(1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015)
frz<-d%>%filter(year%in%years)%>%filter(PEP_ID %in% peps)
many<-frz[which(is.na(frz$Tmin)),]
frz<-frz[!(is.na(frz$Tmin)),]
View(frz)
frz$lat.long<-paste(frz$lat,frz$long)
View(frz)
frz$lat.long<-paste(frz$lat,frz$long, sep=",")
View(frz)
d$lat.long<-paste(d$lat, d$long, sep=",")
View(d)
lats<-unique(frz$lat.long)
d<-filter(d, lat.long%in%lats)
View(d)
dx<-filter(d, lat.long%in%lats)
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(arm)
setwd("~/Documents/git/regionalrisk/analyses/output")
bb<-read.csv("bbch_region_betula.csv", header=TRUE)
clim<-read.csv("climate_betula.csv", header=TRUE)
clim$date<-as.Date(paste(clim$year, clim$month, clim$day, sep="-"))
bb<-bb%>%dplyr::rename("lat" = LAT)%>%dplyr::rename("long"=LON)
x<-paste(bb$YEAR, bb$DAY)
bb$date<-as.Date(strptime(x, format="%Y %j"))
bb$year<-as.numeric(substr(bb$date, 0,4))
bb$month<-as.numeric(substr(bb$date, 6, 7))
bb$day<-as.numeric(substr(bb$date, 9,10))
bb<-bb%>%dplyr::select(-National_ID, -YEAR)
bb$lat<-round(bb$lat, digits=2)
bb$long<-round(bb$long, digits=2)
clim$lat<-round(clim$lat, digits=2)
clim$long<-round(clim$long, digits=2)
d<-full_join(clim, bb)
d<-filter(d, year>=1950)
how_many<-d[which(is.na(d$Tmin)),]
d<-d[!(is.na(d$Tmin) & is.na(d$PEP_ID)),]
df<-d%>%dplyr::select(year, PEP_ID, BBCH)
df$BBCH<-ifelse(df$BBCH>=7, df$BBCH, NA)
df<-df%>%group_by(year,PEP_ID)%>%arrange(year)
df<-na.omit(df)
df <- within(df, { count <- ave(BBCH,PEP_ID, year, FUN=function(x) length(unique(x)))})
df$count<-ifelse(df$count>=2,df$count, NA)
xx<-na.omit(df)
unique(xx$year) ## 1997-2015
peps<-unique(xx$PEP_ID)
years<-c(1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015)
frz<-d%>%filter(year%in%years)%>%filter(PEP_ID %in% peps)
many<-frz[which(is.na(frz$Tmin)),]
frz<-frz[!(is.na(frz$Tmin)),]
frz$lat.long<-paste(frz$lat,frz$long, sep=",")
##### Now find climate data ######
d$lat.long<-paste(d$lat, d$long, sep=",")
lats<-unique(frz$lat.long)
dx<-filter(d, lat.long%in%lats)
dx$frz<- ifelse((lat2$Tmin<=-2.2), 1, 0)
dx$frz<- ifelse((dx$Tmin<=-2.2), 1, 0)
dx$count <- ave(
dx$frz, dx$lat.long, dx$year,
FUN=function(x) cumsum(c(0, head(x, -1)))
)
View(dx)
d$lat.long<-paste(d$lat, d$long, sep=",")
lats<-unique(frz$lat.long)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, lat.long,BBCH)%>%
arrange(lat.long) %>%
filter(row_number()==1 | row_number()==n())
View(dx)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID) %>%
filter(row_number()==1 | row_number()==n())
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID) %>%
filter(row_number()==1 : row_number()==n())
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID) %>%
slice(PEP_ID, 1:n)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID) %>%
slice(1:n)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)
dx<-slice(dx,1:n)
dx<-slice(dx,2:n)
dx<-dplyr::slice(dx,2:n)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-dx%>%arrange(year)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-ungroup(dx)
dx<-dx%>%group_by(year, day, lat.long)%>%arrange(day)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-ungroup(dx)
dx<-dx%>%group_by(year,month, day, lat.long)%>%arrange(day)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-ungroup(dx)
dx<-dx%>%group_by(date, lat.long)%>%arrange(date)
dx<-filter(d, lat.long%in%lats)
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-ungroup(dx)
dx<-dx%>%group_by(date, lat.long)%>%arrange(date)
View(dx)
d$lat.long<-paste(d$lat, d$long, sep=",")
lats<-unique(frz$lat.long)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx<-dx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx$obs<-ifelse(dx$BBCH<11, start, dx$BBCH)
dx$obs<-ifelse(dx$BBCH<=10, start, dx$BBCH)
dxx<- dx[order(dx$BBCH, dx$year), ]
dxx$first<-by(dxx, dxx$BBCH, tail, n=1)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dxx$first<-by(dx, dx$BBCH, dx$year, dx$lat.long, tail, n=1)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dxx<-data.frame(dx,first=!duplicated(dx),last=rev(!duplicated(rev(dx))))
View(dxx)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-data.frame(dx,first=!duplicated(dx),last=rev(!duplicated(rev(dx))))
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx$one<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$first)
dxx$two<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$last)
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx$one<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$first)
dxx$two<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$last)
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx$one<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$first)
dxx$two<-ifelse(dxx$first==TRUE & dxx$last==TRUE, FALSE, dxx$last)
dxx<-dxx%>%dplyr::select(-first, -last)
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year, date)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year, date)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))%>%
dxx<-ungroup(dxx)
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year, date)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-ungroup(dxx)
dxx<-arrange(date)
dxx<-arrange(dxx, date)
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-na.omit(dxx)
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year, date)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-na.omit(dxx)
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
dxx<-dx%>%dplyr::select(PEP_ID, BBCH, lat.long, year, date)
dxx<-dxx%>%
group_by(year, PEP_ID,BBCH)%>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))
dxx<-na.omit(dxx)
dxx<-dplr::select(-date)
dxx<-dplyr::select(-date)
dxx<-dplyr::select(dxx, -date)
dxx$BBCH<-ifelse(is.na(dxx$BBCH), NA, TRUE)
dxx<-data.frame(dxx,first=!duplicated(dxx),last=rev(!duplicated(rev(dxx))))
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(arm)
setwd("~/Documents/git/regionalrisk/analyses/output")
bb<-read.csv("bbch_region_betula.csv", header=TRUE)
clim<-read.csv("climate_betula.csv", header=TRUE)
clim$date<-as.Date(paste(clim$year, clim$month, clim$day, sep="-"))
bb<-bb%>%dplyr::rename("lat" = LAT)%>%dplyr::rename("long"=LON)
x<-paste(bb$YEAR, bb$DAY)
bb$date<-as.Date(strptime(x, format="%Y %j"))
bb$year<-as.numeric(substr(bb$date, 0,4))
bb$month<-as.numeric(substr(bb$date, 6, 7))
bb$day<-as.numeric(substr(bb$date, 9,10))
bb<-bb%>%dplyr::select(-National_ID, -YEAR)
bb$lat<-round(bb$lat, digits=2)
bb$long<-round(bb$long, digits=2)
clim$lat<-round(clim$lat, digits=2)
clim$long<-round(clim$long, digits=2)
d<-full_join(clim, bb)
d<-filter(d, year>=1950)
how_many<-d[which(is.na(d$Tmin)),]
d<-d[!(is.na(d$Tmin) & is.na(d$PEP_ID)),]
df<-d%>%dplyr::select(year, PEP_ID, BBCH)
df$BBCH<-ifelse(df$BBCH>=7, df$BBCH, NA)
df<-df%>%group_by(year,PEP_ID)%>%arrange(year)
df<-na.omit(df)
df <- within(df, { count <- ave(BBCH,PEP_ID, year, FUN=function(x) length(unique(x)))})
df$count<-ifelse(df$count>=2,df$count, NA)
xx<-na.omit(df)
unique(xx$year) ## 1997-2015
peps<-unique(xx$PEP_ID)
years<-c(1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015)
frz<-d%>%filter(year%in%years)%>%filter(PEP_ID %in% peps)
many<-frz[which(is.na(frz$Tmin)),]
frz<-frz[!(is.na(frz$Tmin)),]
frz$lat.long<-paste(frz$lat,frz$long, sep=",")
##### Now find climate data ######
d$lat.long<-paste(d$lat, d$long, sep=",")
lats<-unique(frz$lat.long)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx$BBCH<-ifelse(is.na(dx$BBCH), NA, TRUE)
dx<-data.frame(dx,first=!duplicated(dx),last=rev(!duplicated(rev(dx))))
View(dx)
d$lat.long<-paste(d$lat, d$long, sep=",")
lats<-unique(frz$lat.long)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx<-dx %>%
group_by(PEP_ID, year) %>%
slice(c(1, n())) %>%
ungroup()
dx<-arrange(dx, date)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx<-dx %>%
group_by(PEP_ID, year) %>%
filter(between(row_number(), 1, n()))%>%
ungroup()
dx<-arrange(dx, date)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx<-dx %>%
group_by(PEP_ID, year) %>%
arrange(PEP_ID)%>%
filter(between(row_number(), 1, n()))%>%
ungroup()
dx<-arrange(dx, date)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx<-dx %>%
group_by(PEP_ID, year) %>%
arrange(PEP_ID)%>%
data.frame(first=!duplicated(dx),last=rev(!duplicated(rev(dx))))
ungroup()
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx$grow<-ifelse(is.na(dx$BBCH), NA, TRUE)
dx<-dx %>%
group_by(PEP_ID, year, grow) %>%
arrange(PEP_ID)%>%
data.frame(first=!duplicated(dx),last=rev(!duplicated(rev(dx))))%>%
ungroup()
dx<-arrange(dx, date)
dx<-filter(d, lat.long%in%lats)
dx<-dx[!(is.na(dx$Tmin)),]
dx$grow<-ifelse(is.na(dx$BBCH), NA, TRUE)
dx$count <- ave(
dx$grow, dx$PEP_ID, dx$year,
FUN=function(x) cumsum(c(0, head(x, -1)))
)
dx$grow<-ifelse(is.na(dx$BBCH), NA, TRUE)
dx$count <- ave(
dx$grow, dx$PEP_ID, dx$year,
FUN=function(x) cumsum(c(1, head(x, 0)))
)
dx$grow<-ifelse(is.na(dx$BBCH), NA, TRUE)
dx$count <- ave(
dx$grow, dx$PEP_ID, dx$year,
FUN=function(x) cumsum(c(1, head(x, -1)))
)
dx$frz<- ifelse((dx$Tmin<=-2.2), 1, 0)
try<-dx%>%filter(year==1997)
View(try)
try$total<-paste(try$year, try$PEP_ID, try$count)
t
try$freezes <- ave(
try$frz, try$total,between(try$count==1 | try$count==2),
FUN=function(x) cumsum(c(0, head(x, -1)))
)
try$freezes <- ave(
try$frz, try$total,between(try$count==1, try$count==2),
FUN=function(x) cumsum(c(0, head(x, -1)))
)
try$freezes <- ave(
try$frz, try$total,between(try, try$count==1, try$count==2),
FUN=function(x) cumsum(c(0, head(x, -1)))
)
try$freezes <- ave(
try$frz, try$total,between(try$count, 1, 2),
FUN=function(x) cumsum(c(0, head(x, -1)))
)
repeat{
try$new == TRUE
if(condition){ try$count==1
break (try$count==2)
}
}
repeat{
try$new == TRUE
if(try$count==1){
break (try$count==2)
}
}
repeat{
try$new == TRUE
if(try$count==1, TRUE){
break (try$count==2, FALSE)
}
}
repeat{
try$new == TRUE
if(try$count==1){print(TRUE)
break (try$count==2)
}
}
repeat{
try$new == TRUE
if((try$count==1),print(TRUE)){
break (try$count==2)
}
}
repeat{
try$new == TRUE
if(try$count==1),print(TRUE){
break (try$count==2)
}
}
printvalues <- function(y) {
repeat {
try$count==1;
print(TRUE)
if (! (try$count==2) ) {break}   # Negation is crucial here!
}
}
printvalues
y
